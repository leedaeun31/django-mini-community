{% extends 'main/base.html' %}

{% block content %}
{% if user.is_authenticated %}
<div style="max-width: 800px; margin: 30px auto; padding: 20px;">
    <!-- ì°¸ê°€ ë§í¬ ì…ë ¥ -->
    <div style="margin-bottom: 20px;">
        <label style="font-size: 18px; font-weight: bold;">ì´ˆëŒ€ì½”ë“œ:</label>
        <form method="post" style="display: flex; gap: 10px; margin-top: 10px;">
            {% csrf_token %}
            <input type="text" name="link" placeholder="ì´ˆëŒ€ì½”ë“œ"
                style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px;" required>
            <button type="submit"
                style="background: #f8daf2b9; color: black; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer;">
                ì°¸ê°€
            </button>
        </form>
    </div>

    <!-- ì°¸ê°€ì¤‘ì¸ ë°© -->
    <h2 style="font-size: 20px; font-weight: bold; margin: 20px 0;">ì°¸ê°€ ì¤‘ì¸ ë°©</h2>
    {% if rooms %}
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <div style="display: flex; flex-direction: column; gap: 15px;">
            {% for room in rooms %}
                <a href="javascript:void(0);"
                   class="room-card"
                   onclick="openPinModal('{{ room.slug }}', {% if room.password %}true{% else %}false{% endif %})"
                   style="border: 1px solid #e5e4e4; border-radius: 10px; padding: 20px;
                          background: #f8daf2b9; display: block; text-decoration: none; color: black;
                          transition: transform 0.2s ease;">
                    {{ room.name }}
                </a>
            {% endfor %}
        </div>

        <!-- PIN ì…ë ¥ ëª¨ë‹¬ -->
        <div id="pinModal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3>ğŸ” ë°© PIN ì…ë ¥</h3>
                <input type="password" id="pinInput" maxlength="4" placeholder="4ìë¦¬ PIN ì…ë ¥"
                       style="padding: 8px; margin-bottom: 10px;">
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button onclick="submitPin()" style="background: #ecaddfb9; padding: 5px 10px; border: none; border-radius: 6px; cursor: pointer;">í™•ì¸</button>
                    <button onclick="closePinModal()" style="background: #ccc; padding: 5px 10px; border: none; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <p style="color: #f8daf2b9;">ì•„ì§ ì°¸ê°€í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>
{% else %}
    <h5 id="header_title">ë¡œê·¸ì¸ í›„ ì—¬ëŸ¬ë¶„ë§Œì˜ ì†Œí†µ ê²Œì‹œíŒì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</h5>
{% endif %}

<style>
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
</style>

<script>
    // hover íš¨ê³¼
    document.querySelectorAll('.room-card').forEach(card => {
        card.addEventListener('mouseover', () => {
            card.style.transform = 'scale(1.02)';
            card.style.background = '#f8daf2b9';
        });
        card.addEventListener('mouseout', () => {
            card.style.transform = 'scale(1)';
            card.style.background = '#f8daf2b9';
        });
    });

    let currentRoomSlug = "";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openPinModal(slug, hasPassword) {
        // ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ëŠ” ë°©ì´ë©´ ë°”ë¡œ ì…ì¥
        if (!hasPassword) {
            window.location.href = `/board/${slug}/`;
            return;
        }

        // ì„¸ì…˜ì— ì¸ì¦ëœ ë°©ì´ë©´ PIN ì—†ì´ ë°”ë¡œ ì…ì¥
        fetch(`/board/${slug}/check_session/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.authenticated) {
                window.location.href = `/board/${slug}/`;
            } else {
                // ì„¸ì…˜ì— ì—†ìœ¼ë©´ PIN ì…ë ¥ì°½ ë„ìš°ê¸°
                currentRoomSlug = slug;
                document.getElementById('pinModal').style.display = 'flex';
            }
        });
    }

    function closePinModal() {
        document.getElementById('pinModal').style.display = 'none';
    }

    function submitPin() {
        const pin = document.getElementById("pinInput").value;
        if (pin.length !== 4) {
            alert("4ìë¦¬ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        fetch(`/board/${currentRoomSlug}/check_pin/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ pin })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/board/${currentRoomSlug}/`;
            } else {
                alert("PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });
    }
</script>
{% endblock %}
